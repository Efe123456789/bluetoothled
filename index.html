<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DuoCo Strip Kontrol Arayüzü</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .color-preview {
            width: 100%;
            height: 60px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #e5e7eb;
        }
        .brightness-slider {
            -webkit-appearance: none; /* Safari ve Chrome için */
            -moz-appearance: none;    /* Firefox için */
            appearance: none;         /* Standart özellik */
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: #e5e7eb;
            outline: none;
        }
        .brightness-slider::-webkit-slider-thumb {
            -webkit-appearance: none; /* Safari ve Chrome için */
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
        }
        .brightness-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-5">
    <div class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden p-6">
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">DuoCo Strip Kontrol Merkezi</h1>
            <p class="text-gray-600">LED şeritlerinizi bilgisayardan kontrol edin</p>
        </div>

        <!-- Bağlantı Durumu -->
        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="font-medium text-gray-800">DuoCo Strip Bağlantısı</h3>
                    <p class="text-sm text-gray-600" id="connection-status">Bağlı değil (Bluetooth & Konum gerekli)</p>
                </div>
                <button id="connect-btn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">Bağlan</button>
            </div>
        </div>

        <!-- Renk Seçici -->
        <div class="mb-6">
            <h3 class="font-medium text-gray-800 mb-3">Renk Seçin</h3>
            <div class="color-preview" id="color-preview"></div>
            <input type="color" id="color-picker" value="#3b82f6" class="w-full">
        </div>

        <!-- Parlaklık Ayarı -->
        <div class="mb-6">
            <h3 class="font-medium text-gray-800 mb-3">Parlaklık</h3>
            <input type="range" min="0" max="100" value="50" class="brightness-slider" id="brightness-slider">
            <div class="flex justify-between text-sm text-gray-600 mt-1">
                <span>Düşük</span>
                <span id="brightness-value">50%</span>
                <span>Yüksek</span>
            </div>
        </div>

        <!-- Mod Seçimi -->
        <div class="mb-6">
            <h3 class="font-medium text-gray-800 mb-3">LED Modu</h3>
            <div class="grid grid-cols-2 gap-2">
                <button class="mode-btn px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 transition" data-mode="static">Sabit</button>
                <button class="mode-btn px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 transition" data-mode="blink">Yanıp Sönme</button>
                <button class="mode-btn px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 transition" data-mode="fade">Geçişli</button>
                <button class="mode-btn px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 transition" data-mode="rainbow">Gökkuşağı</button>
            </div>
        </div>

        <!-- Hızlı Ayarlar -->
        <div class="mb-6">
            <h3 class="font-medium text-gray-800 mb-3">Hızlı Ayarlar</h3>
            <div class="grid grid-cols-4 gap-2">
                <button class="preset-btn px-3 py-2 rounded-md text-white" style="background-color: #ff0000">Kırmızı</button>
                <button class="preset-btn px-3 py-2 rounded-md text-white" style="background-color: #00ff00">Yeşil</button>
                <button class="preset-btn px-3 py-2 rounded-md text-white" style="background-color: #0000ff">Mavi</button>
                <button class="preset-btn px-3 py-2 rounded-md text-white" style="background-color: #ffffff">Beyaz</button>
            </div>
        </div>
    </div>

    <script>
        // Bağlantı durumu
        let isConnected = false;
        let device = null;
        
        // İzin kontrol fonksiyonu
        async function checkPermissions() {
            try {
                if (!navigator.bluetooth) {
                    throw new Error('Bluetooth desteklenmiyor');
                }
                
                const permissions = await Promise.all([
                    navigator.permissions.query({name: 'bluetooth'}),
                    navigator.permissions.query({name: 'geolocation'})
                ]);
                
                return permissions.every(p => p.state === 'granted');
            } catch (error) {
                console.error('İzin kontrol hatası:', error);
                return false;
            }
        }
        
        // Öğeleri seçme
        const connectBtn = document.getElementById('connect-btn');
        const statusText = document.getElementById('connection-status');
        const colorPicker = document.getElementById('color-picker');
        const colorPreview = document.getElementById('color-preview');
        const brightnessSlider = document.getElementById('brightness-slider');
        const brightnessValue = document.getElementById('brightness-value');
        const modeButtons = document.querySelectorAll('.mode-btn');
        const presetButtons = document.querySelectorAll('.preset-btn');

        // Bağlantı butonu
        connectBtn.addEventListener('click', async () => {
            if (!isConnected) {
                try {
                    // Konum ve Bluetooth izinlerini kontrol et
                    const handlePermissions = async () => {
                        try {
                            // Explicitly request location permission first
                            const locationGranted = await navigator.permissions.query({name: 'geolocation'});
                            if (locationGranted.state !== 'granted') {
                                await new Promise((resolve, reject) => {
                                    navigator.geolocation.getCurrentPosition(resolve, reject);
                                });
                            }

                            // Then request bluetooth
                            device = await navigator.bluetooth.requestDevice({
                                acceptAllDevices: true, // Try to find any device first
                                optionalServices: ['0000ffe5-0000-1000-8000-00805f9b34fb']
                            });
                            return true;
                        } catch (error) {
                            console.error('Permission error:', error);
                            return false;
                        }
                    };

                    if (!await handlePermissions()) {
                        alert('DuoCo Strip bağlantısı için Bluetooth ve Konum izinleri gereklidir!');
                        return;
                    }
                    
                    // Bağlantıyı kur
                    const server = await device.gatt.connect();
                    isConnected = true;
                    
                    // UI güncelle
                    statusText.textContent = `${device.name} bağlı`;
                    connectBtn.textContent = 'Bağlantıyı Kes';
                    connectBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    connectBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                    
                    // Servis ve karakteristiği bul
                    const service = await server.getPrimaryService('0000ffe5-0000-1000-8000-00805f9b34fb');
                    const characteristic = await service.getCharacteristic('0000ffe9-0000-1000-8000-00805f9b34fb');
                    
                    // Bağlantı kesilirse
                    device.addEventListener('gattserverdisconnected', () => {
                        isConnected = false;
                        statusText.textContent = 'Bağlı değil';
                        connectBtn.textContent = 'Bağlan';
                        connectBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                        connectBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                    });
                    
                } catch (error) {
                    console.error('Bağlantı hatası:', error);
                    let errorMessage = 'Bağlantı hatası oluştu';
                    if (error.name === 'SecurityError') {
                        errorMessage = 'Lütfen tarayıcı ayarlarından konum ve bluetooth izinlerini verin';
                    } else if (error.name === 'NotSupportedError') {
                        errorMessage = 'Bu tarayıcı Web Bluetooth API desteklemiyor';
                    } else if (error.name === 'NotFoundError') {
                        errorMessage = 'DuoCo Strip cihazı bulunamadı. Lütfen cihazın yakında ve açık olduğundan emin olun';
                    }
                    statusText.textContent = errorMessage;
                    alert(errorMessage);
                }
            } else {
                // Bağlantıyı kes
                if (device) {
                    await device.gatt.disconnect();
                }
            }
        });

        // Renk seçicisi
        colorPicker.addEventListener('input', () => {
            const selectedColor = colorPicker.value;
            colorPreview.style.backgroundColor = selectedColor;
            if (isConnected) sendCommand(`color:${selectedColor}`);
        });

        // Parlaklık ayarı
        brightnessSlider.addEventListener('input', () => {
            const value = brightnessSlider.value;
            brightnessValue.textContent = `${value}%`;
            if (isConnected) sendCommand(`brightness:${value}`);
        });

        // Mod butonları
        modeButtons.forEach(button => {
            button.addEventListener('click', () => {
                modeButtons.forEach(btn => btn.classList.remove('bg-blue-500', 'text-white'));
                button.classList.add('bg-blue-500', 'text-white');
                if (isConnected) sendCommand(`mode:${button.dataset.mode}`);
            });
        });

        // Hızlı ayar butonları
        presetButtons.forEach(button => {
            button.addEventListener('click', () => {
                const color = button.style.backgroundColor;
                colorPicker.value = rgbToHex(color);
                colorPreview.style.backgroundColor = color;
                if (isConnected) sendCommand(`color:${rgbToHex(color)}`);
            });
        });

        // RGB rengini hex'e çevirme
        function rgbToHex(rgb) {
            const rgbValues = rgb.match(/\d+/g);
            if (!rgbValues) return '#000000';
            
            const r = parseInt(rgbValues[0]).toString(16).padStart(2, '0');
            const g = parseInt(rgbValues[1]).toString(16).padStart(2, '0');
            const b = parseInt(rgbValues[2]).toString(16).padStart(2, '0');
            
            return `#${r}${g}${b}`;
        }

        // Komut gönderme fonksiyonu
        async function sendCommand(command) {
            if (!device || !isConnected) return;
            
            try {
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('0000ffe5-0000-1000-8000-00805f9b34fb');
                const characteristic = await service.getCharacteristic('0000ffe9-0000-1000-8000-00805f9b34fb');
                
                let value;
                if (command.startsWith('color:')) {
                    const hex = command.substring(6);
                    value = hexToRgbBytes(hex);
                } else if (command.startsWith('brightness:')) {
                    const brightness = parseInt(command.substring(11));
                    value = new Uint8Array([0x04, brightness]);
                } else if (command.startsWith('mode:')) {
                    const mode = command.substring(5);
                    value = getModeCommand(mode);
                }
                
                if (value) {
                    await characteristic.writeValue(value);
                }
            } catch (error) {
                console.error('Komut gönderme hatası:', error);
            }
        }

        function hexToRgbBytes(hex) {
            const r = parseInt(hex.substring(1,3), 16);
            const g = parseInt(hex.substring(3,5), 16);
            const b = parseInt(hex.substring(5,7), 16);
            return new Uint8Array([0x56, r, g, b, 0x00, 0xf0, 0xaa]);
        }

        function getModeCommand(mode) {
            const modes = {
                'static': [0x3c],
                'blink': [0x3d],
                'fade': [0x3e],
                'rainbow': [0x3f]
            };
            return new Uint8Array(modes[mode] || [0x3c]);
        }

        // Başlangıç ayarları
        colorPreview.style.backgroundColor = colorPicker.value;
    </script>
</body>
</html>
